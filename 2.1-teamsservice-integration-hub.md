# TeamsService Integration Hub

> **Relevant source files**
> * [src/java/com/comitfs/openfire/TeamsService.java](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java)

## Purpose and Scope

The `TeamsService` class serves as the central integration hub for the CAS Service Plugin, orchestrating communication between Microsoft Teams, Azure Communication Services, and the Openfire XMPP server. This document covers the architecture, key components, and integration patterns implemented within the `TeamsService` class.

For information about the REST API layer that exposes TeamsService functionality, see [REST API Layer](./2.2-rest-api-layer.md). For details about the test automation framework that TeamsService coordinates with, see [TestPlanner Engine](./3.1-testplanner-engine.md). For WebSocket streaming capabilities, see [WebSocket Audio Streaming](./4.1-websocket-audio-streaming.md).

## Core Architecture

The `TeamsService` class implements a multi-service integration pattern, acting as the primary orchestrator for all external service communications and internal system coordination.

### Service Integration Architecture

```mermaid
flowchart TD

TS["TeamsService"]
setupGraphAPI["setupGraphAPI()"]
setupACS["setupACS()"]
setupEventHubs["setupEventHubs()"]
setupUserProfiles["setupUserProfiles()"]
graphClient["GraphServiceClient graphClient"]
archiveClient["GraphServiceClient archiveClient"]
requestSubscriptions["requestSubscriptions()"]
callAutomationClient["CallAutomationClient"]
smsClient["SmsClient"]
emailClient["EmailClient"]
communicationIdentityClient["CommunicationIdentityClient"]
eventProcessorClient["EventProcessorClient"]
relayListener["HybridConnectionListener"]
testPlanner["TestPlanner"]
testCallConnections["Map testCallConnections"]

setupGraphAPI --> graphClient
setupGraphAPI --> archiveClient
setupACS --> callAutomationClient
setupACS --> smsClient
setupACS --> emailClient
setupACS --> communicationIdentityClient
setupEventHubs --> eventProcessorClient
setupACS --> relayListener
TS --> testPlanner
callAutomationClient --> testCallConnections

subgraph subGraph4 ["Test Infrastructure"]
    testPlanner
    testCallConnections
end

subgraph subGraph3 ["Event Processing"]
    eventProcessorClient
    relayListener
end

subgraph subGraph2 ["Azure Communication Services"]
    callAutomationClient
    smsClient
    emailClient
    communicationIdentityClient
end

subgraph subGraph1 ["Microsoft Graph Integration"]
    graphClient
    archiveClient
    requestSubscriptions
    graphClient --> requestSubscriptions
end

subgraph subGraph0 ["TeamsService Core"]
    TS
    setupGraphAPI
    setupACS
    setupEventHubs
    setupUserProfiles
    TS --> setupGraphAPI
    TS --> setupACS
    TS --> setupEventHubs
    TS --> setupUserProfiles
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L188-L262](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L188-L262)

 [src/java/com/comitfs/openfire/TeamsService.java L305-L381](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L305-L381)

### Class Dependencies and External Services

```mermaid
flowchart TD

MSGraph["Microsoft Graph API"]
MSTeams["Microsoft Teams"]
ACS["Azure Communication Services"]
AzureAI["Azure AI Services"]
EventHubs["Azure Event Hubs"]
BotFramework["Microsoft Bot Framework"]
graphClient["graphClient: GraphServiceClient"]
callAutomationClient["callAutomationClient: CallAutomationClient"]
smsClient["smsClient: SmsClient"]
emailClient["emailClient: EmailClient"]
credentials["credentials: MicrosoftAppCredentials"]
eventProcessorClient["eventProcessorClient: EventProcessorClient"]
tokensLookup["Map tokensLookup"]
phonesLookup["Map phonesLookup"]
msTeamsContacts["Map msTeamsContacts"]
testCallConnections["Map testCallConnections"]

graphClient --> MSGraph
graphClient --> MSTeams
callAutomationClient --> ACS
smsClient --> ACS
emailClient --> ACS
credentials --> BotFramework
eventProcessorClient --> EventHubs
graphClient --> tokensLookup
graphClient --> phonesLookup
graphClient --> msTeamsContacts
callAutomationClient --> testCallConnections

subgraph subGraph2 ["Core Data Structures"]
    tokensLookup
    phonesLookup
    msTeamsContacts
    testCallConnections
end

subgraph subGraph1 ["TeamsService Clients"]
    graphClient
    callAutomationClient
    smsClient
    emailClient
    credentials
    eventProcessorClient
end

subgraph subGraph0 ["External Microsoft Services"]
    MSGraph
    MSTeams
    ACS
    AzureAI
    EventHubs
    BotFramework
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L195-L262](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L195-L262)

 [src/java/com/comitfs/openfire/TeamsService.java L248-L255](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L248-L255)

## Service Initialization and Lifecycle

### Initialization Flow

The `TeamsService` follows a conditional initialization pattern based on configuration properties, enabling different service combinations as needed.

```mermaid
flowchart TD

start["initializeService()"]
checkEnabled["ms.teams.enable.plugin"]
skipInit["Skip initialization"]
checkNgrok["ms.teams.enable.ngrok"]
setupNgrok["setupNgrok()"]
checkIntelliflo["intelliflo.enabled"]
setupIntelliflo["setupIntelliflo()"]
checkACS["acsEndpoint != null"]
setupACS["setupACS()"]
checkEventHubs["acs.eventhubs.enabled"]
setupEventHubs["setupEventHubs()"]
checkGraph["ms.teams.enable.graph"]
setupGraphAPI["setupGraphAPI()"]
setupWebApp["Setup WebApp Context"]
checkGraphClient["graphClient != null"]
setupUserProfiles["setupUserProfiles()"]
createTestPlanner["testPlanner = new TestPlanner()"]
excludeAuth["AuthCheckFilter.addExclude()"]

start --> checkEnabled
checkEnabled --> skipInit
checkEnabled --> checkNgrok
checkNgrok --> setupNgrok
checkNgrok --> checkIntelliflo
setupNgrok --> checkIntelliflo
checkIntelliflo --> setupIntelliflo
checkIntelliflo --> checkACS
setupIntelliflo --> checkACS
checkACS --> setupACS
checkACS --> checkEventHubs
setupACS --> checkEventHubs
checkEventHubs --> setupEventHubs
checkEventHubs --> checkGraph
setupEventHubs --> checkGraph
checkGraph --> setupGraphAPI
checkGraph --> setupWebApp
setupGraphAPI --> checkGraphClient
checkGraphClient --> setupUserProfiles
checkGraphClient --> setupWebApp
setupUserProfiles --> setupWebApp
setupWebApp --> createTestPlanner
createTestPlanner --> excludeAuth
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L305-L381](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L305-L381)

### Service Destruction

The destruction process follows a coordinated shutdown sequence to ensure proper cleanup of resources and connections.

```mermaid
flowchart TD

destroy["destroyService()"]
stopThreads["Stop ngrokThread & devTunnelThread"]
closeWebSockets["WebEventSourceServlet.close()"]
stopEventProcessor["eventProcessorClient.stop()"]
stopWebContexts["Stop jvbWsContext & context"]
destroyTestPlanner["testPlanner.destroy()"]
closeRelay["relayListener.close()"]
removeAuthExcludes["AuthCheckFilter.removeExclude()"]

destroy --> stopThreads
stopThreads --> closeWebSockets
closeWebSockets --> stopEventProcessor
stopEventProcessor --> stopWebContexts
stopWebContexts --> destroyTestPlanner
destroyTestPlanner --> closeRelay
closeRelay --> removeAuthExcludes
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L270-L303](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L270-L303)

## Microsoft Graph API Integration

### Graph Client Management

The `TeamsService` maintains two separate `GraphServiceClient` instances for different operational contexts:

* `graphClient`: Primary client for real-time operations
* `archiveClient`: Dedicated client for subscription and archival operations

```mermaid
flowchart TD

createGraphAPI["createGraphAPI()"]
proxyConfig["Proxy Configuration"]
authProvider["TokenCredentialAuthProvider"]
httpClient["OkHttpClient Builder"]
clientCredentials["ClientSecretCredential"]
scopes["List scopes"]
userProfiles["/users/{email}"]
contacts["/users/{email}/contacts"]
callRecords["/communications/callRecords"]
subscriptions["/subscriptions"]

authProvider --> clientCredentials
authProvider --> scopes
httpClient --> userProfiles
httpClient --> contacts
httpClient --> callRecords
httpClient --> subscriptions

subgraph subGraph2 ["Service Endpoints"]
    userProfiles
    contacts
    callRecords
    subscriptions
end

subgraph subGraph1 ["Authentication Flow"]
    clientCredentials
    scopes
end

subgraph subGraph0 ["Graph Client Creation"]
    createGraphAPI
    proxyConfig
    authProvider
    httpClient
    createGraphAPI --> proxyConfig
    createGraphAPI --> authProvider
    createGraphAPI --> httpClient
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L408-L473](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L408-L473)

 [src/java/com/comitfs/openfire/TeamsService.java L3114-L3271](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L3114-L3271)

### Subscription Management

The subscription system enables real-time notifications for Teams events through webhook callbacks.

```mermaid
flowchart TD

requestSubscriptions["requestSubscriptions()"]
scheduleTimer["Timer.scheduleAtFixedRate()"]
subscribeCallRecords["subscribeForCallRecords()"]
subscribeChats["subscribeForChats()"]
subscribeChannels["subscribeForChannels()"]
deleteOldSub1["deleteSubscription('ms.teams.callrecords.subscription')"]
deleteOldSub2["deleteSubscription('ms.teams.chats.subscription')"]
deleteOldSub3["deleteSubscription('ms.teams.channels.subscription')"]
createCallRecordsSub["new Subscription()"]
createChatsSub["new Subscription()"]
createChannelsSub["new Subscription()"]
setCallbackUrl1["notificationUrl = callbackUrl"]
setCallbackUrl2["notificationUrl = callbackUrl"]
setCallbackUrl3["notificationUrl = callbackUrl"]

requestSubscriptions --> scheduleTimer
scheduleTimer --> subscribeCallRecords
scheduleTimer --> subscribeChats
scheduleTimer --> subscribeChannels
subscribeCallRecords --> deleteOldSub1
subscribeChats --> deleteOldSub2
subscribeChannels --> deleteOldSub3
deleteOldSub1 --> createCallRecordsSub
deleteOldSub2 --> createChatsSub
deleteOldSub3 --> createChannelsSub
createCallRecordsSub --> setCallbackUrl1
createChatsSub --> setCallbackUrl2
createChannelsSub --> setCallbackUrl3
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L475-L559](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L475-L559)

## Azure Communication Services Integration

### ACS Client Initialization

The ACS setup creates multiple specialized clients for different communication services.

```mermaid
flowchart TD

setupACS["setupACS()"]
createEmailClient["EmailClientBuilder().connectionString(acsEndpoint)"]
createSmsClient["SmsClientBuilder().connectionString(acsEndpoint)"]
createIdentityClient["CommunicationIdentityClientBuilder()"]
createControlUser["createControlChannel()"]
createCallAutomation["CallAutomationClientBuilder()"]
setSourceIdentity[".sourceIdentity(controlUser)"]
checkRelay["relayConnectionString && acs.enable.relay"]
createRelay["HybridConnectionListener"]
checkDevTunnel["acs.enable.dev.tunnel"]
setRequestHandler["relayListener.setRequestHandler()"]
startDevTunnel["Start DevTunnel Process"]

setupACS --> createEmailClient
setupACS --> createSmsClient
setupACS --> createIdentityClient
setupACS --> createControlUser
createControlUser --> createCallAutomation
createCallAutomation --> setSourceIdentity
setupACS --> checkRelay
checkRelay --> createRelay
checkRelay --> checkDevTunnel
createRelay --> setRequestHandler
checkDevTunnel --> startDevTunnel
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L4514-L4618](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4514-L4618)

### Call Automation Workflow

The call automation system provides comprehensive telephony capabilities through ACS.

```mermaid
flowchart TD

makeOmniCall["makeOmniCall()"]
determineIdentifier["Determine CommunicationIdentifier"]
phoneNumber["PhoneNumberIdentifier"]
teamsUser["MicrosoftTeamsUserIdentifier"]
acsUser["CommunicationUserIdentifier"]
createCallOptions["CreateCallOptions"]
callIntelligence["CallIntelligenceOptions"]
mediaStreaming["MediaStreamingOptions"]
transcription["TranscriptionOptions"]
startTestCall["startTestCall()"]
sendVoiceCommand["sendVoiceCommand()"]
sendDTMF["sendDTMF()"]
stopTestCall["stopTestCall()"]
testCallConnections["testCallConnections Map"]

makeOmniCall --> createCallOptions
startTestCall --> makeOmniCall
sendVoiceCommand --> testCallConnections
sendDTMF --> testCallConnections
stopTestCall --> testCallConnections

subgraph subGraph2 ["Test Framework"]
    startTestCall
    sendVoiceCommand
    sendDTMF
    stopTestCall
end

subgraph subGraph1 ["Call Management"]
    createCallOptions
    callIntelligence
    mediaStreaming
    transcription
    createCallOptions --> callIntelligence
    createCallOptions --> mediaStreaming
    createCallOptions --> transcription
end

subgraph subGraph0 ["Call Initiation"]
    makeOmniCall
    determineIdentifier
    phoneNumber
    teamsUser
    acsUser
    makeOmniCall --> determineIdentifier
    determineIdentifier --> phoneNumber
    determineIdentifier --> teamsUser
    determineIdentifier --> acsUser
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L4645-L4817](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4645-L4817)

 [src/java/com/comitfs/openfire/TeamsService.java L4686-L4760](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4686-L4760)

## Openlink Protocol Implementation

### Call Status Management

The `TeamsService` implements the Openlink protocol for call control and status reporting.

```mermaid
flowchart TD

updateCall["updateCall()"]
getUserInterest["getUserInterest()"]
getUserCalls["getUserCalls()"]
storeCallState["Store in ms_teams_calls property"]
doOpenlinkAction["doOpenlinkAction()"]
makeCall["makeCall action"]
requestAction["requestAction"]
clearCall["ClearCall action"]
getCallsInJson["getCallsInJson()"]
createCallObject["new Call()"]
setCallProperties["Set CallDirection, CallState"]
addParticipants["Add Participants"]
addActions["Add Valid Actions"]

updateCall --> doOpenlinkAction
doOpenlinkAction --> getCallsInJson

subgraph subGraph2 ["Call State Generation"]
    getCallsInJson
    createCallObject
    setCallProperties
    addParticipants
    addActions
    getCallsInJson --> createCallObject
    createCallObject --> setCallProperties
    setCallProperties --> addParticipants
    addParticipants --> addActions
end

subgraph subGraph1 ["Action Processing"]
    doOpenlinkAction
    makeCall
    requestAction
    clearCall
    doOpenlinkAction --> makeCall
    doOpenlinkAction --> requestAction
    doOpenlinkAction --> clearCall
end

subgraph subGraph0 ["Call Status Tracking"]
    updateCall
    getUserInterest
    getUserCalls
    storeCallState
    updateCall --> getUserInterest
    updateCall --> getUserCalls
    updateCall --> storeCallState
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L4036-L4095](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4036-L4095)

 [src/java/com/comitfs/openfire/TeamsService.java L3591-L3691](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L3591-L3691)

 [src/java/com/comitfs/openfire/TeamsService.java L3517-L3575](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L3517-L3575)

### Interest and User Management

The system maintains user interests and contact relationships for call routing.

```mermaid
flowchart TD

setupUserProfiles["setupUserProfiles()"]
cachePhones["cachePhones()"]
msTeamsLookup["msTeamsLookup Map"]
phonesLookup["phonesLookup Map"]
getUserInterest["getUserInterest()"]
checkDirection["direction == 'Incoming'"]
checkMSTeamsUser["Check microsoftTeamsUserId"]
useDefault["Use default interest"]
isUserInterest["isUserInterest()"]
rosterCheck["Roster.isRosterItem()"]
postCallStatus["postCallStatus()"]
getUserFromUid["getUserFromUid()"]
updateCall["updateCall"]

updateCall --> getUserInterest

subgraph subGraph2 ["Call Routing"]
    postCallStatus
    getUserFromUid
    updateCall
    postCallStatus --> getUserFromUid
    getUserFromUid --> updateCall
end

subgraph subGraph0 ["User Interest Resolution"]
    getUserInterest
    checkDirection
    checkMSTeamsUser
    useDefault
    isUserInterest
    rosterCheck
    getUserInterest --> checkDirection
    checkDirection --> checkMSTeamsUser
    checkDirection --> useDefault
    checkMSTeamsUser --> isUserInterest
    isUserInterest --> rosterCheck
end

subgraph subGraph1 ["Contact Caching"]
    setupUserProfiles
    cachePhones
    msTeamsLookup
    phonesLookup
    setupUserProfiles --> cachePhones
    cachePhones --> msTeamsLookup
    cachePhones --> phonesLookup
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L4097-L4193](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4097-L4193)

 [src/java/com/comitfs/openfire/TeamsService.java L4486-L4506](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4486-L4506)

 [src/java/com/comitfs/openfire/TeamsService.java L4268-L4450](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4268-L4450)

## Event Processing and Webhooks

### Event Hub Processing

The system processes various Azure Communication Services events through Event Hubs.

```mermaid
flowchart TD

PARTITION_PROCESSOR["PARTITION_PROCESSOR Consumer"]
parseEventData["Parse EventData.getBodyAsString()"]
checkEventType["Check eventType"]
smsReceived["Microsoft.Communication.SMSReceived"]
incomingCall["Microsoft.Communication.IncomingCall"]
callStarted["Microsoft.Communication.CallStarted"]
callEnded["Microsoft.Communication.CallEnded"]
advancedMessage["Microsoft.Communication.AdvancedMessageReceived"]
handleSms["handleSms()"]
handleACSIncomingCall["handleACSIncomingCall()"]
handleACSCallStarted["handleACSCallStarted()"]
handleACSCallEnded["handleACSCallEnded()"]
handleAdvancedMessage["handleAdvancedMessage()"]

checkEventType --> smsReceived
checkEventType --> incomingCall
checkEventType --> callStarted
checkEventType --> callEnded
checkEventType --> advancedMessage
smsReceived --> handleSms
incomingCall --> handleACSIncomingCall
callStarted --> handleACSCallStarted
callEnded --> handleACSCallEnded
advancedMessage --> handleAdvancedMessage

subgraph subGraph2 ["Event Handlers"]
    handleSms
    handleACSIncomingCall
    handleACSCallStarted
    handleACSCallEnded
    handleAdvancedMessage
end

subgraph subGraph1 ["Event Types"]
    smsReceived
    incomingCall
    callStarted
    callEnded
    advancedMessage
end

subgraph subGraph0 ["Event Processing Pipeline"]
    PARTITION_PROCESSOR
    parseEventData
    checkEventType
    PARTITION_PROCESSOR --> parseEventData
    parseEventData --> checkEventType
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L4890-L5000](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4890-L5000)

### Relay Listener Processing

The `HybridConnectionListener` processes real-time events from Azure Service Bus.

```mermaid
flowchart TD

relayListener["relayListener.setRequestHandler()"]
readInputStream["Read InputStream"]
parseJSON["Parse JSON Array"]
routeEvents["Route by eventType"]
handleEvent["Handle Specific Event"]
setResponse["response.setStatusCode(202)"]
closeResponse["response.close()"]

routeEvents --> handleEvent

subgraph subGraph1 ["Response Handling"]
    handleEvent
    setResponse
    closeResponse
    handleEvent --> setResponse
    setResponse --> closeResponse
end

subgraph subGraph0 ["Relay Request Handler"]
    relayListener
    readInputStream
    parseJSON
    routeEvents
    relayListener --> readInputStream
    readInputStream --> parseJSON
    parseJSON --> routeEvents
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L4528-L4583](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L4528-L4583)

## Data Structures and State Management

### Core Data Maps

The `TeamsService` maintains several key data structures for state management and lookups.

| Data Structure | Type | Purpose |
| --- | --- | --- |
| `tokensLookup` | `Map<String, String>` | Authentication token management |
| `phonesLookup` | `Map<String, MsContact>` | Phone number to contact mapping |
| `msTeamsContacts` | `Map<String, JSONArray>` | User contacts from Graph API |
| `msTeamsLookup` | `Map<String, String>` | Various identifier lookups |
| `meetingCallIds` | `Map<String, MsContact>` | Meeting call tracking |
| `testCallConnections` | `Map<String, CallConnection>` | Active test call connections |
| `callIds` | `HashMap<String, String>` | Call ID to interest mapping |

Sources: [src/java/com/comitfs/openfire/TeamsService.java L248-L262](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L248-L262)

### Configuration Properties

Key configuration properties that control service behavior:

| Property | Default | Purpose |
| --- | --- | --- |
| `ms.teams.enable.plugin` | `true` | Enable/disable TeamsService |
| `ms.teams.enable.graph` | `false` | Enable Graph API integration |
| `acs.endpoint` | `null` | Azure Communication Services endpoint |
| `ms.teams.enable.subscription` | `false` | Enable Teams subscriptions |
| `acs.eventhubs.enabled` | `false` | Enable Event Hub processing |

Sources: [src/java/com/comitfs/openfire/TeamsService.java L199-L224](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L199-L224)

## Integration Patterns

### Callback URL Strategy

The service uses a unified callback URL pattern for webhook notifications:

```mermaid
flowchart TD

callbackUrl["callbackUrl = publicUrl + '/notify-call-records'"]
publicUrl["publicUrl = ms.teams.public.url"]
websocketUrl["websocketUrl = ms.teams.websocket.url"]
graphSubscriptions["Graph API Subscriptions"]
acsCallbacks["ACS Call Automation"]
mediaStreaming["Media Streaming"]
transcription["Transcription Services"]

callbackUrl --> graphSubscriptions
callbackUrl --> acsCallbacks
websocketUrl --> mediaStreaming
websocketUrl --> transcription

subgraph subGraph1 ["Usage Contexts"]
    graphSubscriptions
    acsCallbacks
    mediaStreaming
    transcription
end

subgraph subGraph0 ["Callback Configuration"]
    callbackUrl
    publicUrl
    websocketUrl
end
```

Sources: [src/java/com/comitfs/openfire/TeamsService.java L221-L224](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/comitfs/openfire/TeamsService.java#L221-L224)

The `TeamsService` class represents a sophisticated integration hub that coordinates multiple Microsoft and Azure services while maintaining compatibility with the Openfire XMPP server architecture. Its modular design allows for flexible deployment scenarios while providing comprehensive communication and collaboration capabilities.