# WebSocket Audio Streaming

> **Relevant source files**
> * [src/java/org/ifsoft/openfire/WebEventSourceServlet.java](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/openfire/WebEventSourceServlet.java)
> * [src/java/org/ifsoft/websockets/LiveStreamSocket.java](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java)
> * [src/web/docs/index.html](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/web/docs/index.html)
> * [src/web/docs/openapi.yaml](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/web/docs/openapi.yaml)

## Purpose and Scope

This document covers the server-side WebSocket implementation for real-time audio streaming in the CAS Service Plugin. The `LiveStreamSocket` class provides bidirectional audio data transmission, real-time transcription processing, and call control capabilities between Azure Communication Services (ACS) and connected clients.

For client-side audio processing and Web Audio API integration, see [Client-Side Audio Processing](./4.2-client-side-audio-processing.md). For WebRTC peer connection management, see [WebRTC Integration](./4.3-webrtc-integration.md).

## LiveStreamSocket Architecture

The `LiveStreamSocket` class serves as the primary WebSocket endpoint for audio streaming functionality, implementing the Eclipse Jetty WebSocket API to handle real-time communication between ACS calls and web clients.

```mermaid
flowchart TD

LSS["LiveStreamSocket<br>@WebSocket"]
streamConsumers["streamConsumers<br>Map<String, LiveStreamSocket>"]
onTextMethod["onTextMethod()<br>JSON Message Handler"]
AudioMetadata["AudioMetadata<br>Processing"]
AudioData["AudioData<br>Processing"]
TranscriptionData["TranscriptionData<br>Processing"]
ActionHandlers["Action Handlers<br>DTMF & Voice Commands"]
TeamsService["TeamsService.self"]
TestPlanner["TestPlanner.transcripts"]
ACS["Azure Communication<br>Services"]
onConnect["onConnect()<br>Session Setup"]
onClose["onClose()<br>Cleanup"]
wsSession["Session<br>Jetty WebSocket"]

LSS --> onConnect
LSS --> onTextMethod
LSS --> onClose
onConnect --> streamConsumers
onConnect --> TestPlanner
ActionHandlers --> TeamsService
TranscriptionData --> TestPlanner
onClose --> streamConsumers

subgraph subGraph3 ["Connection Management"]
    onConnect
    onClose
    wsSession
end

subgraph subGraph2 ["External Integration"]
    TeamsService
    TestPlanner
    ACS
    TeamsService --> ACS
end

subgraph subGraph1 ["Message Processing"]
    onTextMethod
    AudioMetadata
    AudioData
    TranscriptionData
    ActionHandlers
    onTextMethod --> AudioMetadata
    onTextMethod --> AudioData
    onTextMethod --> TranscriptionData
    onTextMethod --> ActionHandlers
end

subgraph subGraph0 ["WebSocket Layer"]
    LSS
    streamConsumers
end
```

Sources: [src/java/org/ifsoft/websockets/LiveStreamSocket.java L31-L68](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L31-L68)

## Connection Types and Initialization

The `LiveStreamSocket` supports two distinct connection types based on the initialization parameters, each serving different purposes in the audio streaming workflow.

| Connection Type | Identifier | Purpose | Transcript Storage |
| --- | --- | --- | --- |
| Stream Consumer | `query` parameter | Receives published audio/transcription data | No |
| Call Producer | `path` parameter with `callKey` | Produces audio data from ACS calls | Yes |

```mermaid
flowchart TD

Constructor["LiveStreamSocket(query, path)"]
onConnect["onConnect(Session)"]
QueryCheck["query != null?"]
AddConsumer["streamConsumers.put(query, this)"]
ExtractCallKey["callKey = path.substring<br>(path.lastIndexOf('/') + 1)"]
GetTranscript["transcript = TestPlanner<br>.transcripts.get(callKey)"]
CreateTranscript["new ConcurrentLinkedQueue()"]
StoreTranscript["TestPlanner.transcripts<br>.put(callKey, transcript)"]

onConnect --> QueryCheck
QueryCheck --> ExtractCallKey

subgraph subGraph2 ["Producer Path"]
    ExtractCallKey
    GetTranscript
    CreateTranscript
    StoreTranscript
    ExtractCallKey --> GetTranscript
    GetTranscript --> CreateTranscript
    CreateTranscript --> StoreTranscript
end

subgraph subGraph1 ["Consumer Path"]
    QueryCheck
    AddConsumer
    QueryCheck --> AddConsumer
end

subgraph subGraph0 ["Connection Establishment"]
    Constructor
    onConnect
    Constructor --> onConnect
end
```

Sources: [src/java/org/ifsoft/websockets/LiveStreamSocket.java L44-L68](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L44-L68)

## Message Types and Processing

The WebSocket endpoint processes structured JSON messages representing different types of audio and control data from Azure Communication Services.

### Audio and Transcription Messages

```mermaid
flowchart TD

onTextMethod["onTextMethod(String data)"]
JSONParse["JSONObject json = new JSONObject(data)"]
KindCheck["json.getString('kind')"]
AudioMetadata["AudioMetadata<br>encoding, sampleRate, channels, length"]
AudioData["AudioData<br>timestamp, data, silent"]
AddServerCallId["json.put('serverCallId', callKey)"]
TranscriptionMetadata["TranscriptionMetadata<br>subscriptionId, locale, callConnectionId"]
TranscriptionData["TranscriptionData<br>text, confidence, offset, duration"]
ProcessTranscript["text.toLowerCase()"]
StoreTranscript["transcript.add(text)"]
PublishLoop["for (LiveStreamSocket socket : streamConsumers.values())"]
SendMessage["socket.wsSession.getRemote()<br>.sendString(json.toString())"]

KindCheck --> AudioMetadata
KindCheck --> AudioData
KindCheck --> TranscriptionData
AudioData --> PublishLoop
AddServerCallId --> PublishLoop
StoreTranscript --> PublishLoop

subgraph Distribution ["Distribution"]
    PublishLoop
    SendMessage
    PublishLoop --> SendMessage
end

subgraph subGraph2 ["Transcription Messages"]
    TranscriptionMetadata
    TranscriptionData
    ProcessTranscript
    StoreTranscript
    TranscriptionData --> ProcessTranscript
    ProcessTranscript --> StoreTranscript
end

subgraph subGraph1 ["Audio Messages"]
    AudioMetadata
    AudioData
    AddServerCallId
    AudioMetadata --> AddServerCallId
end

subgraph subGraph0 ["Message Processing Flow"]
    onTextMethod
    JSONParse
    KindCheck
    onTextMethod --> JSONParse
    JSONParse --> KindCheck
end
```

Sources: [src/java/org/ifsoft/websockets/LiveStreamSocket.java L97-L180](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L97-L180)

### Control Action Processing

The WebSocket endpoint handles two types of call control actions: DTMF tone transmission and voice command synthesis.

| Action Type | Parameters | Integration Method |
| --- | --- | --- |
| `sendDTMF` | `dtmf`, `phoneNo`, `serverCallId` | `TeamsService.self.sendDTMF()` |
| `voiceCommand` | `command`, `phoneNo`, `serverCallId`, `gender`, `language` | `TeamsService.self.sendVoiceCommand()` |

```mermaid
flowchart TD

ActionCheck["json.has('action')"]
GetAction["action = json.getString('action')"]
DTMFCheck["action.equals('sendDTMF')"]
ExtractDTMF["dtmf = json.getString('dtmf')<br>phoneNo = json.getString('phoneNo')<br>serverCallId = json.getString('serverCallId')"]
SendDTMF["TeamsService.self.sendDTMF<br>(serverCallId, dtmf, phoneNo)"]
VoiceCheck["action.equals('voiceCommand')"]
ExtractVoice["command = json.getString('command')<br>phoneNo = json.getString('phoneNo')<br>serverCallId = json.getString('serverCallId')<br>gender = json.getString('gender')<br>language = json.getString('language')"]
SendVoice["TeamsService.self.sendVoiceCommand<br>(serverCallId, command, phoneNo, gender + '|' + language)"]

GetAction --> DTMFCheck
GetAction --> VoiceCheck

subgraph subGraph2 ["Voice Command Handling"]
    VoiceCheck
    ExtractVoice
    SendVoice
    VoiceCheck --> ExtractVoice
    ExtractVoice --> SendVoice
end

subgraph subGraph1 ["DTMF Handling"]
    DTMFCheck
    ExtractDTMF
    SendDTMF
    DTMFCheck --> ExtractDTMF
    ExtractDTMF --> SendDTMF
end

subgraph subGraph0 ["Action Processing"]
    ActionCheck
    GetAction
    ActionCheck --> GetAction
end
```

Sources: [src/java/org/ifsoft/websockets/LiveStreamSocket.java L184-L206](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L184-L206)

## Connection Management and Cleanup

The WebSocket implementation provides robust connection lifecycle management with proper cleanup procedures for both consumer and producer connections.

```mermaid
flowchart TD

isOpen["isOpen()<br>return wsSession.isOpen()"]
deliver["deliver(byte[] binaryData)"]
disconnect["disconnect()"]
onConnect["onConnect(Session wsSession)"]
ActiveConnection["wsSession.isOpen()"]
onClose["onClose(int statusCode, String reason)"]
onError["onError(Throwable error)"]
RemoveConsumer["streamConsumers.remove(query)"]
AddCloseMarker["transcript.add('close')"]
CloseConsumers["for (LiveStreamSocket socket : streamConsumers.values())"]
CloseSession["socket.wsSession.close()"]

onClose --> RemoveConsumer
onClose --> AddCloseMarker

subgraph subGraph2 ["Producer Cleanup"]
    AddCloseMarker
    CloseConsumers
    CloseSession
    AddCloseMarker --> CloseConsumers
    CloseConsumers --> CloseSession
end

subgraph subGraph1 ["Consumer Cleanup"]
    RemoveConsumer
end

subgraph subGraph0 ["Connection Lifecycle"]
    onConnect
    ActiveConnection
    onClose
    onError
    onConnect --> ActiveConnection
    ActiveConnection --> onClose
    ActiveConnection --> onError
end

subgraph subGraph3 ["Utility Methods"]
    isOpen
    deliver
    disconnect
    deliver --> isOpen
    disconnect --> isOpen
end
```

Sources: [src/java/org/ifsoft/websockets/LiveStreamSocket.java L49-L51](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L49-L51)

 [src/java/org/ifsoft/websockets/LiveStreamSocket.java L71-L91](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L71-L91)

 [src/java/org/ifsoft/websockets/LiveStreamSocket.java L217-L247](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L217-L247)

## Integration with Testing Framework

The `LiveStreamSocket` integrates closely with the `TestPlanner` for automated call testing, providing real-time transcript collection and call monitoring capabilities.

### Transcript Management

| Component | Data Structure | Purpose |
| --- | --- | --- |
| `TestPlanner.transcripts` | `Map<String, ConcurrentLinkedQueue<String>>` | Stores per-call transcription text |
| `callKey` | `String` (from path) | Unique identifier for call session |
| `transcript` | `ConcurrentLinkedQueue<String>` | Thread-safe transcript storage |

```mermaid
flowchart TD

ACSTranscript["ACS Transcription<br>Service"]
TranscriptionData["TranscriptionData<br>JSON Message"]
ProcessText["text.toLowerCase()"]
QueueAdd["transcript.add(text)"]
TestPlannerMap["TestPlanner.transcripts<br>Map<String, ConcurrentLinkedQueue<String>>"]
CallKey["callKey<br>(extracted from path)"]
TranscriptQueue["ConcurrentLinkedQueue<String><br>(per-call transcript)"]
CloseMarker["'close'<br>End-of-call marker"]

QueueAdd --> TranscriptQueue
CloseMarker --> TranscriptQueue

subgraph subGraph2 ["Cleanup Markers"]
    CloseMarker
end

subgraph subGraph1 ["TestPlanner Integration"]
    TestPlannerMap
    CallKey
    TranscriptQueue
    CallKey --> TestPlannerMap
    TestPlannerMap --> TranscriptQueue
end

subgraph subGraph0 ["Transcript Flow"]
    ACSTranscript
    TranscriptionData
    ProcessText
    QueueAdd
    ACSTranscript --> TranscriptionData
    TranscriptionData --> ProcessText
    ProcessText --> QueueAdd
end
```

Sources: [src/java/org/ifsoft/websockets/LiveStreamSocket.java L60-L65](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L60-L65)

 [src/java/org/ifsoft/websockets/LiveStreamSocket.java L167-L169](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L167-L169)

 [src/java/org/ifsoft/websockets/LiveStreamSocket.java L78-L80](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/websockets/LiveStreamSocket.java#L78-L80)

## REST API Integration

The WebSocket audio streaming functionality is exposed through the REST API endpoint for establishing streaming connections between ACS calls and the CAS service.

### Stream Establishment Endpoint

| Endpoint | Method | Parameters | Purpose |
| --- | --- | --- | --- |
| `/casapi/v1/companion/stream/{callId}/{confId}` | POST | `callId`, `confId` | Establish bi-directional audio streaming |

The endpoint is documented in the OpenAPI specification as supporting the establishment of bi-directional audio streaming between an ACS call and the CAS Audiobridge service.

Sources: [src/web/docs/openapi.yaml L94-L117](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/web/docs/openapi.yaml#L94-L117)