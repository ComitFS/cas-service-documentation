# WebRTC Integration

> **Relevant source files**
> * [src/java/org/ifsoft/webrtc/WHEPClient.java](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java)
> * [src/java/org/ifsoft/webrtc/example.txt](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/example.txt)

This document covers the WebRTC integration components in the CAS service, specifically the WHEP (WebRTC HTTP Egress Protocol) client implementation for receiving real-time media streams. The WebRTC integration enables the system to consume audio and video streams from remote endpoints using standardized WebRTC protocols.

For information about client-side audio processing and Web Audio API integration, see [Client-Side Audio Processing](./4.2-client-side-audio-processing.md). For WebSocket-based audio streaming capabilities, see [WebSocket Audio Streaming](./4.1-websocket-audio-streaming.md).

## WHEP Protocol Implementation

The CAS service implements a WHEP client through the `WHEPClient` class, which handles the WebRTC HTTP Egress Protocol for receiving media streams from remote endpoints.

### WHEP Client Architecture

```mermaid
flowchart TD

WHEPClient["WHEPClient"]
PeerConnection["RTCPeerConnection<br>peerConnection"]
HttpClient["OkHttpClient<br>httpClient"]
Factory["PeerConnectionFactory<br>peerConnectionFactory"]
OpusEncoder["OpusEncoder<br>encoder"]
OpusDecoder["OpusDecoder<br>decoder"]
WhepUrl["URL<br>whepUrl"]
StreamKey["String<br>streamKey"]
DevOnvoidWebRTC["dev.onvoid.webrtc<br>WebRTC Library"]
OkHttp["okhttp3<br>HTTP Client"]
Opus4j["de.maxhenkel.opus4j<br>Opus Codec"]

PeerConnection --> DevOnvoidWebRTC
HttpClient --> OkHttp
OpusEncoder --> Opus4j
OpusDecoder --> Opus4j

subgraph subGraph4 ["External Dependencies"]
    DevOnvoidWebRTC
    OkHttp
    Opus4j
end

subgraph subGraph3 ["WHEPClient Class"]
    WHEPClient
    WHEPClient --> PeerConnection
    WHEPClient --> HttpClient
    WHEPClient --> Factory
    WHEPClient --> OpusEncoder
    WHEPClient --> OpusDecoder
    WHEPClient --> WhepUrl
    WHEPClient --> StreamKey

subgraph Configuration ["Configuration"]
    WhepUrl
    StreamKey
end

subgraph subGraph1 ["Codec Support"]
    OpusEncoder
    OpusDecoder
end

subgraph subGraph0 ["Core Components"]
    PeerConnection
    HttpClient
    Factory
end
end
```

**Sources:** [src/java/org/ifsoft/webrtc/WHEPClient.java L1-L238](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L1-L238)

### WHEP Protocol Flow

```mermaid
sequenceDiagram
  participant WHEPClient
  participant OkHttpClient
  participant WHEP Endpoint
  participant RTCPeerConnection

  WHEPClient->>WHEPClient: "start(url, streamKey)"
  WHEPClient->>OkHttpClient: "Initialize HTTP client"
  WHEPClient->>WHEPClient: "initializePeerConnection()"
  WHEPClient->>RTCPeerConnection: "createOffer()"
  RTCPeerConnection-->>WHEPClient: "RTCSessionDescription offer"
  WHEPClient->>WHEPClient: "setLocalDescription(offer)"
  WHEPClient->>OkHttpClient: "POST offer to /whep endpoint"
  OkHttpClient->>WHEP Endpoint: "SDP Offer with Authorization header"
  WHEP Endpoint-->>OkHttpClient: "SDP Answer response"
  OkHttpClient-->>WHEPClient: "onResponse(answer)"
  WHEPClient->>RTCPeerConnection: "setRemoteDescription(answer)"
  RTCPeerConnection->>WHEPClient: "onIceCandidate() callbacks"
  RTCPeerConnection->>WHEPClient: "onTrack() callbacks for media"
  note over WHEPClient,RTCPeerConnection: "Media streaming active"
  WHEPClient->>WHEPClient: "Audio data processing via AudioTrack.addSink()"
```

**Sources:** [src/java/org/ifsoft/webrtc/WHEPClient.java L55-L76](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L55-L76)

 [src/java/org/ifsoft/webrtc/WHEPClient.java L133-L160](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L133-L160)

 [src/java/org/ifsoft/webrtc/WHEPClient.java L162-L192](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L162-L192)

## WebRTC Peer Connection Management

The `WHEPClient` manages WebRTC peer connections with focus on receive-only audio streaming capabilities.

### Peer Connection Configuration

| Component | Configuration | Purpose |
| --- | --- | --- |
| `RTCConfiguration` | `iceTransportPolicy = RTCIceTransportPolicy.ALL` | Accept all ICE transport types |
| `RTCRtpTransceiverInit` | `direction = RTCRtpTransceiverDirection.RECV_ONLY` | Receive-only mode for media |
| `AudioOptions` | Default configuration | Audio track source settings |
| Connection Pool | 5 connections, 5 minute timeout | HTTP client optimization |

### Connection Lifecycle Management

```mermaid
stateDiagram-v2
    [*] --> Initializing : "start(url, streamKey)"
    Initializing --> CreatingOffer : "initializePeerConnection()"
    CreatingOffer --> SendingOffer : "createLocalOffer()"
    SendingOffer --> WaitingAnswer : "sendLocalOffer()"
    WaitingAnswer --> Connected : "onRemoteAnswer() success"
    WaitingAnswer --> Failed : "HTTP error or SDP error"
    Connected --> MediaStreaming : "onTrack() callback"
    Failed --> Restarting : "scheduleRestart()"
    Connected --> Closed : "stop()"
    MediaStreaming --> Closed : "stop()"
    Restarting --> Initializing : "Auto restart"
    Closed --> [*] : "Audio data processing"
```

**Sources:** [src/java/org/ifsoft/webrtc/WHEPClient.java L93-L131](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L93-L131)

 [src/java/org/ifsoft/webrtc/WHEPClient.java L78-L91](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L78-L91)

 [src/java/org/ifsoft/webrtc/WHEPClient.java L211-L223](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L211-L223)

## Audio Processing Pipeline

The WebRTC integration includes Opus codec support for efficient audio encoding and decoding.

### Audio Track Processing

```mermaid
flowchart TD

RemoteAudio["Remote Audio Track"]
Transceiver["RTCRtpTransceiver"]
Receiver["RTCRtpReceiver"]
AudioTrack["AudioTrack"]
AudioSink["AudioTrack.addSink()"]
AudioData["Audio Data Callback"]
OpusDecoder["OpusDecoder<br>decoder"]
OpusEncoder["OpusEncoder<br>encoder"]
SampleRate["24000 Hz sample rate"]
Channels["1 channel (mono)"]
FrameSize["960 frame size"]
MaxPayload["1500 max payload"]

RemoteAudio --> Transceiver
AudioTrack --> AudioSink
SampleRate --> OpusDecoder
SampleRate --> OpusEncoder
Channels --> OpusDecoder
Channels --> OpusEncoder
FrameSize --> OpusDecoder
MaxPayload --> OpusEncoder

subgraph Configuration ["Configuration"]
    SampleRate
    Channels
    FrameSize
    MaxPayload
end

subgraph subGraph2 ["Audio Processing"]
    AudioSink
    AudioData
    OpusDecoder
    OpusEncoder
    AudioSink --> AudioData
    AudioData --> OpusDecoder
    AudioData --> OpusEncoder
end

subgraph subGraph1 ["WebRTC Reception"]
    Transceiver
    Receiver
    AudioTrack
    Transceiver --> Receiver
    Receiver --> AudioTrack
end

subgraph subGraph0 ["Remote Media Stream"]
    RemoteAudio
end
```

**Sources:** [src/java/org/ifsoft/webrtc/WHEPClient.java L105-L119](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L105-L119)

 [src/java/org/ifsoft/webrtc/WHEPClient.java L63-L67](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L63-L67)

### Opus Codec Configuration

The system configures Opus codecs for VOIP-optimized audio processing:

```
// Opus encoder configuration
encoder = new OpusEncoder(24000, 1, OpusEncoder.Application.VOIP);
encoder.setMaxPayloadSize(1500);

// Opus decoder configuration  
decoder = new OpusDecoder(24000, 1);
decoder.setFrameSize(960);
```

**Sources:** [src/java/org/ifsoft/webrtc/WHEPClient.java L63-L67](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L63-L67)

## HTTP Signaling Layer

The WHEP implementation uses HTTP for WebRTC signaling, following the WHEP specification for media consumption.

### HTTP Request Structure

| Method | Endpoint | Content-Type | Purpose |
| --- | --- | --- | --- |
| POST | `/whep` | `application/sdp` | Send SDP offer |
| Authorization | Bearer token | `streamKey` | Stream authentication |

### Error Handling and Recovery

```mermaid
flowchart TD

HTTPError["HTTP Request Failure"]
SDPError["SDP Processing Error"]
ConnectionError["Peer Connection Failure"]
ScheduleRestart["scheduleRestart()"]
CloseConnection["peerConnection.close()"]
CloseCodecs["encoder.close(), decoder.close()"]
Reset["reset() state"]
NewConnection["Create new PeerConnection"]
NewOffer["Generate new SDP offer"]
RetryHTTP["Retry HTTP signaling"]

HTTPError --> ScheduleRestart
SDPError --> ScheduleRestart
ConnectionError --> ScheduleRestart
Reset --> NewConnection

subgraph subGraph2 ["Restart Process"]
    NewConnection
    NewOffer
    RetryHTTP
    NewConnection --> NewOffer
    NewOffer --> RetryHTTP
end

subgraph subGraph1 ["Recovery Actions"]
    ScheduleRestart
    CloseConnection
    CloseCodecs
    Reset
    ScheduleRestart --> CloseConnection
    ScheduleRestart --> CloseCodecs
    CloseConnection --> Reset
    CloseCodecs --> Reset
end

subgraph subGraph0 ["Error Detection"]
    HTTPError
    SDPError
    ConnectionError
end
```

**Sources:** [src/java/org/ifsoft/webrtc/WHEPClient.java L166-L191](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L166-L191)

 [src/java/org/ifsoft/webrtc/WHEPClient.java L211-L223](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L211-L223)

 [src/java/org/ifsoft/webrtc/WHEPClient.java L78-L91](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L78-L91)

## Integration Points

The WebRTC integration connects with the broader CAS system through several integration points:

### Initialization and Configuration

The `WHEPClient` provides a hardcoded initialization example that demonstrates integration with a media server:

```
public void init() {
    start("https://pade.chat:5443/orinayo/api", "2be5d3c9-068b-4d6a-89d0-c337449aba27");
}
```

### System Dependencies

| Dependency | Purpose | Integration |
| --- | --- | --- |
| `dev.onvoid.webrtc` | Core WebRTC functionality | Native WebRTC operations |
| `okhttp3` | HTTP client operations | WHEP protocol communication |
| `de.maxhenkel.opus4j` | Opus audio codec | Audio encoding/decoding |
| SLF4J | Logging framework | System logging integration |

**Sources:** [src/java/org/ifsoft/webrtc/WHEPClient.java L51-L53](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L51-L53)

 [src/java/org/ifsoft/webrtc/WHEPClient.java L16-L40](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/ifsoft/webrtc/WHEPClient.java#L16-L40)

The WebRTC integration provides the foundation for real-time media consumption within the CAS service, enabling the system to receive and process audio streams from remote WebRTC endpoints using the standardized WHEP protocol.