# Third-Party Service Integrations

> **Relevant source files**
> * [src/java/com/ifsoft/openlink/view/Summary.java](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/ifsoft/openlink/view/Summary.java)
> * [src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java)

This document covers the integration of external third-party services with the CAS Service Plugin, excluding Microsoft core services and Azure Communication Services which are documented separately. For Microsoft services integration, see [Microsoft Services Integration](./6.1-microsoft-services-integration.md). For Azure Communication Services integration, see [Azure Communication Services](./6.2-azure-communication-services.md).

The CAS system integrates with several third-party platforms to provide comprehensive business workflow capabilities including CRM functionality, messaging services, and AI-powered features. These integrations are primarily exposed through the `CasCompanionService` REST API and managed by the `TeamsService` integration hub.

## Integration Architecture Overview

The third-party service integrations follow a consistent pattern where external services are accessed through the `TeamsService` integration hub, exposed via REST endpoints in `CasCompanionService`, and monitored through the system status framework.

```mermaid
flowchart TD

RestAPI["CasCompanionService<br>REST API Layer"]
TeamsHub["TeamsService<br>Integration Hub"]
StatusMonitor["Summary Servlet<br>Status Monitoring"]
Intelliflo["Intelliflo CRM<br>Financial Services Platform"]
WhatsApp["WhatsApp Business API<br>Messaging Platform"]
AzureAI["Azure AI Services<br>LLaMA & Text Analytics"]
SMTP["External Email Services<br>SMTP Providers"]
TeamsApp["Microsoft Teams App<br>CAS Companion"]
WebClients["Web-based Clients<br>Browser Applications"]

TeamsApp --> RestAPI
WebClients --> RestAPI
TeamsHub --> Intelliflo
TeamsHub --> WhatsApp
TeamsHub --> AzureAI
TeamsHub --> SMTP

subgraph subGraph2 ["Client Applications"]
    TeamsApp
    WebClients
end

subgraph subGraph1 ["Third-Party Services"]
    Intelliflo
    WhatsApp
    AzureAI
    SMTP
end

subgraph subGraph0 ["CAS Service Plugin"]
    RestAPI
    TeamsHub
    StatusMonitor
    RestAPI --> TeamsHub
    StatusMonitor --> TeamsHub
end
```

**Sources:** [src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java L75-L79](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java#L75-L79)

 [src/java/com/ifsoft/openlink/view/Summary.java L24-L25](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/ifsoft/openlink/view/Summary.java#L24-L25)

## Intelliflo CRM Integration

The CAS system provides comprehensive integration with Intelliflo, a financial services CRM platform, enabling financial advisers to access client and lead information directly through the Teams application interface.

### Client Management APIs

The Intelliflo integration exposes client management functionality through dedicated REST endpoints that allow financial advisers to retrieve and manage client information.

```mermaid
flowchart TD

GetClients["/intelliflo/clients<br>GET - List Clients"]
GetClient["/intelliflo/clients/{clientId}<br>GET - Client Details"]
AddOneNote["/intelliflo/clients/{clientId}/onenote<br>POST - Add OneNote URL"]
GetEntities["getAdviserEntities()<br>Entity Retrieval"]
IntellifloGet["doIntellifloGet()<br>GET Request Handler"]
IntellifloPost["doIntellifloPost()<br>POST Request Handler"]
ClientsAPI["/clients<br>Client Records"]
ContactsAPI["/clients/{id}/contactdetails<br>Contact Management"]

GetClients --> GetEntities
GetClient --> IntellifloGet
AddOneNote --> IntellifloPost
GetEntities --> ClientsAPI
IntellifloGet --> ClientsAPI
IntellifloPost --> ContactsAPI

subgraph subGraph2 ["Intelliflo CRM"]
    ClientsAPI
    ContactsAPI
end

subgraph subGraph1 ["TeamsService Methods"]
    GetEntities
    IntellifloGet
    IntellifloPost
end

subgraph subGraph0 ["CasCompanionService Endpoints"]
    GetClients
    GetClient
    AddOneNote
end
```

The client management functionality is implemented through several REST endpoints:

| Endpoint | Method | Purpose | Implementation |
| --- | --- | --- | --- |
| `/intelliflo/clients` | GET | Retrieve adviser's client list | `getAdviserClients()` |
| `/intelliflo/clients/{clientId}` | GET | Get specific client details | `getAdviserClient()` |
| `/intelliflo/clients/{clientId}/onenote` | POST | Add OneNote URL to client | `addClientOneNoteUrl()` |

**Sources:** [src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java L1429-L1499](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java#L1429-L1499)

### Lead Management APIs

The system provides similar functionality for managing leads, allowing financial advisers to track potential clients through the CRM integration.

```mermaid
flowchart TD

LeadsEndpoint["/intelliflo/leads<br>getAdviserLeads()"]
LeadEndpoint["/intelliflo/leads/{leadId}<br>getAdviserLead()"]
TeamsServiceCall["TeamsService.self<br>getAdviserEntities('leads', user)"]
IntellifloAPI["doIntellifloGet()<br>/leads/{leadId}"]
JSONArray["JSONArray<br>Lead Collection"]
JSONObject["JSONObject<br>Lead Details"]

LeadsEndpoint --> TeamsServiceCall
LeadEndpoint --> IntellifloAPI
TeamsServiceCall --> JSONArray
IntellifloAPI --> JSONObject

subgraph subGraph2 ["Data Response"]
    JSONArray
    JSONObject
end

subgraph subGraph1 ["Backend Processing"]
    TeamsServiceCall
    IntellifloAPI
end

subgraph subGraph0 ["Lead Management Flow"]
    LeadsEndpoint
    LeadEndpoint
end
```

**Sources:** [src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java L1501-L1545](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java#L1501-L1545)

## WhatsApp Business API Integration

The CAS system integrates with WhatsApp Business API through Azure's messaging infrastructure to enable automated WhatsApp messaging capabilities for client communication.

### WhatsApp Template Messaging

The WhatsApp integration uses template-based messaging to ensure compliance with WhatsApp Business API requirements and enable automated client notifications.

```mermaid
sequenceDiagram
  participant Teams Client
  participant CasCompanionService
  participant TeamsService
  participant Azure WhatsApp Integration
  participant WhatsApp Business API

  Teams Client->>CasCompanionService: "POST /workflow/whatsapp/{to}/{template}"
  CasCompanionService->>CasCompanionService: "Authenticate user"
  CasCompanionService->>TeamsService: "sendToWhatsApp(to, template, value)"
  TeamsService->>Azure WhatsApp Integration: "Send template message request"
  Azure WhatsApp Integration->>WhatsApp Business API: "Template message with parameters"
  WhatsApp Business API-->>Azure WhatsApp Integration: "Delivery confirmation"
  Azure WhatsApp Integration-->>TeamsService: "Response status"
  TeamsService-->>CasCompanionService: "Success/failure result"
  CasCompanionService-->>Teams Client: "HTTP response"
```

The WhatsApp integration endpoint accepts template-based messages with the following parameters:

* **to**: Destination telephone number
* **template**: WhatsApp template name
* **value**: Template parameter values

**Sources:** [src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java L1107-L1124](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java#L1107-L1124)

## Azure AI Services Integration

The CAS system incorporates AI-powered features through Azure AI services, providing text summarization and generative AI capabilities for enhanced user productivity.

### Text Summarization Service

The text summarization feature uses Azure AI services to provide automated content summarization for business communications and documents.

```mermaid
flowchart TD

SummarizeEndpoint["/summarise<br>POST - Text Summarization"]
PromptEndpoint["/prompt<br>POST - LLaMA AI Response"]
UserValidation["ensureUserExists()<br>User Authentication"]
TeamsServiceAI["TeamsService.self<br>AI Method Calls"]
TextSummary["getTextSummary()<br>Azure AI Analytics"]
LLaMAResponse["getLLaMAReply()<br>Hosted LLaMA Model"]

SummarizeEndpoint --> UserValidation
PromptEndpoint --> UserValidation
TeamsServiceAI --> TextSummary
TeamsServiceAI --> LLaMAResponse

subgraph subGraph2 ["AI Services"]
    TextSummary
    LLaMAResponse
end

subgraph subGraph1 ["Processing Layer"]
    UserValidation
    TeamsServiceAI
    UserValidation --> TeamsServiceAI
end

subgraph subGraph0 ["AI Service Endpoints"]
    SummarizeEndpoint
    PromptEndpoint
end
```

### AI Service Implementation

Both AI services follow a consistent pattern:

1. **User Authentication**: Validate the requesting user through `ensureUserExists()`
2. **Service Delegation**: Forward requests to `TeamsService` for processing
3. **Response Handling**: Return AI-generated content to the client

| Service | Endpoint | Method | Purpose |
| --- | --- | --- | --- |
| Text Summarization | `/summarise` | POST | Summarize provided text using Azure AI |
| LLaMA AI | `/prompt` | POST | Generate responses using hosted LLaMA model |

**Sources:** [src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java L1008-L1054](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java#L1008-L1054)

## External Email Services Integration

The CAS system supports external email services beyond Azure Communication Services, providing flexibility in email delivery and integration with existing enterprise email infrastructure.

### Email Service Configuration

The email integration is managed through the `TeamsService.sendEmail()` method, which can route messages through various email providers based on system configuration.

```mermaid
flowchart TD

EmailEndpoint["/email/{subject}/{email}<br>sendMail()"]
TeamsServiceEmail["TeamsService.self<br>sendEmail()"]
AzureEmail["Azure Email Services<br>Primary Provider"]
SMTPServices["External SMTP<br>Alternative Providers"]
GraphAPI["MS Graph API<br>Enterprise Integration"]

TeamsServiceEmail --> AzureEmail
TeamsServiceEmail --> SMTPServices
TeamsServiceEmail --> GraphAPI

subgraph subGraph1 ["Email Providers"]
    AzureEmail
    SMTPServices
    GraphAPI
end

subgraph subGraph0 ["Email Integration"]
    EmailEndpoint
    TeamsServiceEmail
    EmailEndpoint --> TeamsServiceEmail
end
```

The email service accepts the following parameters:

* **subject**: Email subject line
* **email**: Destination email address
* **body**: Email content (request body)

**Sources:** [src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java L974-L1000](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java#L974-L1000)

## Service Status Monitoring

The system provides comprehensive status monitoring for all third-party service integrations through the `Summary` servlet, enabling administrators to verify service connectivity and health.

### Status Monitoring Implementation

```mermaid
flowchart TD

SummaryServlet["Summary Servlet<br>/summary endpoint"]
StatusCheck["Component Status Validation<br>Service Health Checks"]
RestAPIStatus["Jersey REST API<br>JerseyWrapper.getLoadingStatusMessage()"]
ACSIdentity["ACS Identity Client<br>communicationIdentityClient"]
EmailClient["Email Client Status<br>emailClient"]
SMSClient["SMS Client Status<br>smsClient"]
EventHub["Azure Event Hub<br>eventProcessorClient"]

StatusCheck --> RestAPIStatus
StatusCheck --> ACSIdentity
StatusCheck --> EmailClient
StatusCheck --> SMSClient
StatusCheck --> EventHub

subgraph subGraph1 ["Monitored Components"]
    RestAPIStatus
    ACSIdentity
    EmailClient
    SMSClient
    EventHub
end

subgraph subGraph0 ["Status Monitoring System"]
    SummaryServlet
    StatusCheck
    SummaryServlet --> StatusCheck
end
```

The status monitoring system checks various service components and displays their health status through visual indicators:

* **Success**: Green checkmark icon (`success-16x16.gif`)
* **Error**: Red error icon (`error-16x16.gif`)
* **Forbidden**: Warning icon (`forbidden-16x16.gif`)

**Sources:** [src/java/com/ifsoft/openlink/view/Summary.java L112-L187](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/com/ifsoft/openlink/view/Summary.java#L112-L187)

## Integration Security and Authentication

All third-party service integrations implement consistent security patterns through the CAS authentication framework, ensuring secure access to external services while maintaining user context and permissions.

### Authentication Flow

```mermaid
sequenceDiagram
  participant Client Application
  participant CasCompanionService
  participant Authentication Layer
  participant Third-Party Service

  Client Application->>CasCompanionService: "Request with Basic Auth"
  CasCompanionService->>Authentication Layer: "getEndUser() - Extract credentials"
  Authentication Layer->>Authentication Layer: "BasicAuth.decode()"
  Authentication Layer->>CasCompanionService: "Username validated"
  CasCompanionService->>CasCompanionService: "ensureUserExists(username)"
  CasCompanionService->>Third-Party Service: "Authenticated service call"
  Third-Party Service-->>CasCompanionService: "Service response"
  CasCompanionService-->>Client Application: "JSON response"
```

The authentication process ensures that:

1. All requests are authenticated using HTTP Basic Authentication
2. User accounts are validated against the Openfire user database
3. Service calls maintain user context for authorization
4. Responses are properly formatted and secured

**Sources:** [src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java L560-L578](https://github.com/ComitFS/cas-service/blob/b7087e8d/src/java/org/jivesoftware/openfire/plugin/rest/service/CasCompanionService.java#L560-L578)