# Build System & CI/CD

> **Relevant source files**
> * [.github/workflows/build.yml](https://github.com/ComitFS/cas-service/blob/b7087e8d/.github/workflows/build.yml)
> * [changelog.html](https://github.com/ComitFS/cas-service/blob/b7087e8d/changelog.html)
> * [pom.xml](https://github.com/ComitFS/cas-service/blob/b7087e8d/pom.xml)

This document covers the Maven-based build system and GitHub Actions CI/CD pipeline used to compile, test, package, and deploy the CAS Service Plugin. The build system handles dependency management, Openfire plugin assembly, multi-Java version compatibility, and automated security scanning.

For information about deployment and development tools, see [Development Tools](./7.2-development-tools.md). For system requirements and architectural decisions, see [Requirements & Documentation](./7.3-requirements-and-documentation.md).

## Maven Build Configuration

The CAS Service Plugin uses Maven as its primary build system, configured as an Openfire plugin through the parent POM structure. The project inherits from the Openfire plugins parent and extends it with comprehensive dependency management for Microsoft services integration.

### Project Structure

| Property | Value | Purpose |
| --- | --- | --- |
| `groupId` | `org.igniterealtime.openfire.plugins` | Openfire plugin namespace |
| `artifactId` | `casapi` | Plugin identifier |
| `version` | `0.4.0-SNAPSHOT` | Current development version |
| `parent.version` | `4.8.0` | Openfire compatibility target |

The build configuration defines specific version properties for major dependency groups:

```mermaid
flowchart TD

POM["pom.xml<br>Main Build Config"]
Parent["Openfire Parent POM<br>4.8.0"]
Props["Version Properties<br>jersey.version: 2.36<br>jackson.version: 2.13.2<br>netty.version: 4.1.108.Final"]
Assembly["maven-assembly-plugin<br>Plugin Packaging"]
Jetty["jetty-jspc-maven-plugin<br>JSP Compilation"]
DepCheck["dependency-check-maven<br>OWASP Security Scan"]
Suppressions[".dependency-check-suppressions.xml<br>Security Exception Rules"]

POM --> Assembly
POM --> Jetty
POM --> DepCheck

subgraph subGraph2 ["Security Profile"]
    DepCheck
    Suppressions
    DepCheck --> Suppressions
end

subgraph subGraph1 ["Build Plugins"]
    Assembly
    Jetty
end

subgraph subGraph0 ["Build Configuration"]
    POM
    Parent
    Props
    POM --> Parent
    POM --> Props
end
```

Sources: [pom.xml L1-L45](https://github.com/ComitFS/cas-service/blob/b7087e8d/pom.xml#L1-L45)

### Dependency Management

The build system manages an extensive set of dependencies organized into functional groups. The dependency structure supports the plugin's integration with Microsoft services, Azure Communication Services, and real-time communication features.

```mermaid
flowchart TD

Quartz["Quartz Scheduler 2.3.2<br>Test Automation<br>Cron Jobs"]
Nashorn["Nashorn JavaScript 15.6<br>Script Engine<br>Test Execution"]
OpenCSV["OpenCSV 5.11<br>Test Data Processing<br>CSV Scenarios"]
WebRTC["WebRTC Java 0.10.0<br>webrtc-java<br>Platform-specific natives"]
Speech["Azure Speech SDK 1.41.1<br>Cognitive Services<br>client-sdk"]
Opus["Opus Audio Codec<br>opus4j 2.0.4<br>Audio Processing"]
AzureCore["Azure Core 1.44.1<br>azure-core<br>azure-identity"]
AzureComm["Communication APIs<br>azure-communication-*<br>chat, sms, email, identity"]
AzureCall["Call Automation<br>azure-communication-callautomation<br>1.4.0-beta.1"]
AzureEvent["Event Processing<br>azure-messaging-*<br>eventgrid, eventhubs"]
MSGraph["Microsoft Graph 5.80.0<br>microsoft-graph<br>microsoft-graph-core"]
MSBot["Bot Framework 4.14.0<br>bot-connector<br>bot-schema"]
MSAL["MSAL4J 1.17.1<br>Authentication<br>msal4j"]
Jersey["Jersey 2.36<br>REST Framework<br>jersey-container-jetty-jersey-media-"]
Jackson["Jackson 2.13.2<br>JSON Processing<br>jackson-module-jaxb<br>jackson-jaxrs-json"]
Netty["Netty 4.1.108.Final<br>Network Framework<br>netty-all"]

subgraph subGraph4 ["Testing & Automation"]
    Quartz
    Nashorn
    OpenCSV
end

subgraph subGraph3 ["Media & Real-time"]
    WebRTC
    Speech
    Opus
end

subgraph subGraph2 ["Azure Communication Services"]
    AzureCore
    AzureComm
    AzureCall
    AzureEvent
end

subgraph subGraph1 ["Microsoft Integration"]
    MSGraph
    MSBot
    MSAL
end

subgraph subGraph0 ["Core Framework Dependencies"]
    Jersey
    Jackson
    Netty
end
```

Sources: [pom.xml L47-L340](https://github.com/ComitFS/cas-service/blob/b7087e8d/pom.xml#L47-L340)

### Build Profiles and Security

The Maven configuration includes a security-focused build profile that integrates OWASP dependency checking to identify known vulnerabilities in the dependency tree.

| Profile | Purpose | Key Plugin |
| --- | --- | --- |
| `deps` | Security vulnerability scanning | `dependency-check-maven:7.1.1` |

The security profile configuration:

* Skips provided and runtime scopes to focus on bundled dependencies
* Uses custom suppression rules from `.dependency-check-suppressions.xml`
* Integrates with CI/CD for automated security gates

Sources: [pom.xml L342-L369](https://github.com/ComitFS/cas-service/blob/b7087e8d/pom.xml#L342-L369)

## CI/CD Pipeline Architecture

The GitHub Actions workflow implements a comprehensive CI/CD pipeline that supports multiple Java versions, automated testing, and conditional artifact publishing. The pipeline is designed to ensure compatibility across different Java runtime environments.

### Pipeline Stages

```mermaid
flowchart TD

Push["Push to Repository"]
PR["Pull Request"]
PluginXML["Read plugin.xml<br>minJavaVersion<br>minServerVersion"]
JavaMatrix["Generate Java Matrix<br>[8,11,17] or [11,17]<br>Based on Requirements"]
Checkout["Checkout Repository<br>actions/checkout@v3"]
SetupJDK["Setup JDK Matrix<br>actions/setup-java@v3<br>Temurin Distribution"]
Cache["Cache Maven Repo<br>actions/cache@v3<br>~/.m2/repository"]
CITooling["Clone CI Tooling<br>igniterealtime/ci-tooling<br>Maven Settings"]
MavenBuild["Maven Package<br>mvn -B package"]
Assembly["Generate Plugin JAR<br>*-openfire-plugin-assembly.jar"]
TagCheck["Check for Tag Release<br>refs/tags/*"]
Upload["Upload to GitHub Release<br>upload-release-asset@v1"]

Push --> PluginXML
PR --> PluginXML
JavaMatrix --> Checkout
Cache --> CITooling
Assembly --> TagCheck

subgraph subGraph4 ["Artifact Publishing"]
    TagCheck
    Upload
    TagCheck --> Upload
end

subgraph subGraph3 ["Build Process"]
    CITooling
    MavenBuild
    Assembly
    CITooling --> MavenBuild
    MavenBuild --> Assembly
end

subgraph subGraph2 ["Build Matrix Execution"]
    Checkout
    SetupJDK
    Cache
    Checkout --> SetupJDK
    SetupJDK --> Cache
end

subgraph subGraph1 ["Java Version Selection"]
    PluginXML
    JavaMatrix
    PluginXML --> JavaMatrix
end

subgraph subGraph0 ["Trigger Events"]
    Push
    PR
end
```

Sources: [.github/workflows/build.yml L1-L125](https://github.com/ComitFS/cas-service/blob/b7087e8d/.github/workflows/build.yml#L1-L125)

### Java Version Compatibility Matrix

The CI/CD system dynamically determines Java version compatibility based on plugin metadata:

| Condition | Java Versions | Rationale |
| --- | --- | --- |
| `minJavaVersion == 11` OR `minServerVersion =~ 4.8.*` | `[11, 17]` | Modern Openfire compatibility |
| Default | `[8, 11, 17]` | Broad compatibility testing |

The pipeline uses conditional logic in the `select_java` job to read the `plugin.xml` file and determine appropriate Java versions for testing:

Sources: [.github/workflows/build.yml L44-L52](https://github.com/ComitFS/cas-service/blob/b7087e8d/.github/workflows/build.yml#L44-L52)

### Build Environment Configuration

The CI system sets up a standardized build environment:

1. **Repository Caching**: Maven repository artifacts are cached using a composite key based on OS, Java version, and POM file hash
2. **CI Tooling Integration**: Downloads Ignite Realtime CI tooling for standardized Maven settings
3. **Artifact Generation**: Produces deployable JAR files with the naming pattern `{artifactId}-openfire-plugin-assembly.jar`

```mermaid
flowchart TD

Workspace["GitHub Actions Workspace<br>ubuntu-latest"]
JavaSetup["JDK Setup<br>Temurin Distribution<br>Matrix: 8, 11, 17"]
MavenCache["Maven Cache<br>~/.m2/repository<br>Hash-based Key"]
CIRepo["igniterealtime/ci-tooling<br>Standardized Settings"]
MavenSettings["maven-settings-for-openfire-plugins.xml<br>Repository Configuration"]
MavenPackage["mvn -B package<br>Batch Mode Build"]
PluginAssembly["Plugin JAR Assembly<br>target/casapi-openfire-plugin-assembly.jar"]

MavenCache --> CIRepo
MavenSettings --> MavenPackage

subgraph subGraph2 ["Build Execution"]
    MavenPackage
    PluginAssembly
    MavenPackage --> PluginAssembly
end

subgraph subGraph1 ["CI Configuration"]
    CIRepo
    MavenSettings
    CIRepo --> MavenSettings
end

subgraph subGraph0 ["Build Environment Setup"]
    Workspace
    JavaSetup
    MavenCache
    Workspace --> JavaSetup
    JavaSetup --> MavenCache
end
```

Sources: [.github/workflows/build.yml L89-L113](https://github.com/ComitFS/cas-service/blob/b7087e8d/.github/workflows/build.yml#L89-L113)

## Build Artifacts and Packaging

The build system produces Openfire-compatible plugin artifacts through the Maven assembly process. The packaging integrates with Openfire's plugin architecture while bundling all necessary dependencies.

### Artifact Structure

| Artifact Type | Location | Purpose |
| --- | --- | --- |
| Plugin JAR | `target/casapi-openfire-plugin-assembly.jar` | Deployable Openfire plugin |
| Compiled Classes | `target/classes/` | Java bytecode |
| Web Resources | Integrated into JAR | Servlet and static content |
| Dependencies | Bundled in JAR | Runtime libraries |

The assembly process uses the `maven-assembly-plugin` to create a complete plugin package that includes:

* Compiled Java classes from `src/java`
* Web application resources
* Dependency libraries
* Plugin metadata (`plugin.xml`)

Sources: [pom.xml L34-L45](https://github.com/ComitFS/cas-service/blob/b7087e8d/pom.xml#L34-L45)

 [.github/workflows/build.yml L110-L113](https://github.com/ComitFS/cas-service/blob/b7087e8d/.github/workflows/build.yml#L110-L113)

### Repository Configuration

The build system integrates with multiple Maven repositories to resolve dependencies:

```mermaid
flowchart TD

Central["Maven Central<br>Default Repository"]
Ignite["Ignite Realtime<br>igniterealtime.org/archiva<br>Openfire Dependencies"]
Azure["Azure SDK Repository<br>pkgs.dev.azure.com<br>azure-sdk-for-java"]
MaxHenkel["Max Henkel Repository<br>maven.maxhenkel.de<br>Opus4J Codec"]
Dependencies["Dependency Resolution<br>Multi-repository Lookup"]
Plugins["Plugin Resolution<br>Maven Plugin Dependencies"]

Central --> Dependencies
Ignite --> Dependencies
Azure --> Dependencies
MaxHenkel --> Dependencies
Ignite --> Plugins

subgraph subGraph2 ["Build Resolution"]
    Dependencies
    Plugins
end

subgraph subGraph1 ["Specialized Repositories"]
    Azure
    MaxHenkel
end

subgraph subGraph0 ["Primary Repositories"]
    Central
    Ignite
end
```

Sources: [pom.xml L371-L413](https://github.com/ComitFS/cas-service/blob/b7087e8d/pom.xml#L371-L413)

## Version Management and Releases

The project follows semantic versioning with snapshot development cycles. The current development version `0.4.0-SNAPSHOT` indicates active development toward the next minor release.

### Release History

| Version | Release Date | Milestone |
| --- | --- | --- |
| `0.1.0` | October 21, 2024 | Initial release |
| `0.2.0` | November 30, 2024 | Feature expansion |
| `0.4.0-SNAPSHOT` | Current | Active development |

The CI/CD pipeline automatically publishes artifacts to GitHub Releases when tags are pushed, but only for specific Java versions to avoid duplicate artifacts:

* Java 8 builds are published for broad compatibility
* Java 11 builds are published when it's the minimum supported version
* Java 17 builds provide testing but don't produce separate artifacts

Sources: [changelog.html L47-L55](https://github.com/ComitFS/cas-service/blob/b7087e8d/changelog.html#L47-L55)

 [.github/workflows/build.yml L115-L124](https://github.com/ComitFS/cas-service/blob/b7087e8d/.github/workflows/build.yml#L115-L124)